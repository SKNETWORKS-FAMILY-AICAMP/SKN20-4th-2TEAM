{% extends 'chatbot/base.html' %}

{% block title %}í”„ë¡œì íŠ¸ ê´€ë¦¬ - PaperSnack{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<style>
    :root {
        --sidebar-width: 280px;
    }

    [data-theme="dark"] {
        --primary: #fbbf24;
        --primary-dark: #f59e0b;
        --text-dark: #f5f5f5;
        --text-gray: #d1d1d1;
        --bg-light: #1a1714;
        --white: #2a2622;
        --border: #3f3832;
        --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
        font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-light);
        color: var(--text-gray);
        min-height: 100vh;
        transition: background 0.3s, color 0.3s;
    }

    /* Layout */
    .container {
        display: flex;
        height: 100vh;
        margin: 0 auto;
        background: var(--white);
        box-shadow: 0 10px 40px var(--shadow);
        padding-top: 80px;
    }

    /* Project Sidebar */
    .project-sidebar {
        width: var(--sidebar-width);
        background: var(--bg-light);
        border-right: 2px solid var(--border);
        display: flex;
        flex-direction: column;
    }

    .project-header {
        padding: 1.5rem 1rem;
        border-bottom: 2px solid var(--border);
    }

    .project-header h3 {
        font-size: 1rem;
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-weight: 800;
    }

    .btn-new-project {
        width: 100%;
        padding: 0.8rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
    }

    .btn-new-project:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
    }

    .project-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        min-height: 0;
    }

    .project-item {
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .project-item:hover {
        border-color: var(--primary);
        transform: translateX(5px);
        box-shadow: 0 4px 12px var(--shadow);
    }

    .project-item.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .project-item-name {
        font-size: 0.9rem;
        font-weight: 700;
    }

    .project-item-count {
        font-size: 0.75rem;
        color: var(--text-gray);
        background: var(--bg-light);
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-weight: 700;
    }

    .project-item.active .project-item-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .all-chats-item {
        background: var(--bg-light);
        font-weight: 800;
    }

    .all-chats-item.active {
        background: var(--primary);
    }

    /* Main Area */
    .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--white);
        overflow: hidden;
    }

    .main-header {
        padding: 1.5rem 2rem;
        border-bottom: 2px solid var(--border);
        background: var(--bg-light);
    }

    .main-header h2 {
        font-size: 1.5rem;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        font-weight: 900;
    }

    .main-header p {
        font-size: 0.9rem;
        color: var(--text-gray);
        font-weight: 600;
    }

    .search-box {
        margin-top: 1rem;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.8rem 1rem 0.8rem 2.5rem;
        background: var(--white);
        border: 2px solid var(--border);
        border-radius: 10px;
        color: var(--text-dark);
        font-size: 0.95rem;
        outline: none;
        transition: all 0.3s;
        font-weight: 600;
    }

    .search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .search-input::placeholder {
        color: var(--text-gray);
    }

    .search-icon {
        position: absolute;
        left: 0.8rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1rem;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .chat-card {
        background: var(--bg-light);
        border: 2px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .chat-card:hover {
        border-color: var(--primary);
        transform: translateY(-5px);
        box-shadow: 0 20px 40px var(--shadow);
    }

    .chat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.8rem;
    }

    .chat-card-question {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text-dark);
        flex: 1;
        margin-right: 1rem;
    }

    .chat-card-time {
        font-size: 0.75rem;
        color: var(--text-gray);
        white-space: nowrap;
        font-weight: 600;
    }

    .chat-card-answer {
        font-size: 0.85rem;
        color: var(--text-gray);
        line-height: 1.6;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        margin-bottom: 0.8rem;
    }

    .chat-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.8rem;
        border-top: 2px solid var(--border);
    }

    .search-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 800;
    }

    .search-badge.internal {
        background: #d1e7dd;
        color: #0f5132;
    }

    .search-badge.hybrid {
        background: #cfe2ff;
        color: #084298;
    }

    .search-badge.vector {
        background: #e2d9f3;
        color: #59359a;
    }

    .search-badge.cluster {
        background: #cfe2ff;
        color: #084298;
    }

    .search-badge.web {
        background: #fff3cd;
        color: #664d03;
    }

    .search-badge.rejected {
        background: #f8d7da;
        color: #842029;
    }

    [data-theme="dark"] .search-badge.internal {
        background: #0f5132;
        color: #d1e7dd;
    }

    [data-theme="dark"] .search-badge.hybrid {
        background: #084298;
        color: #cfe2ff;
    }

    [data-theme="dark"] .search-badge.vector {
        background: #59359a;
        color: #e2d9f3;
    }

    [data-theme="dark"] .search-badge.cluster {
        background: #084298;
        color: #cfe2ff;
    }

    [data-theme="dark"] .search-badge.web {
        background: #664d03;
        color: #fff3cd;
    }

    [data-theme="dark"] .search-badge.rejected {
        background: #842029;
        color: #f8d7da;
    }

    .source-count {
        font-size: 0.75rem;
        color: var(--text-gray);
        font-weight: 700;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-gray);
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--text-dark);
        font-weight: 900;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(63, 45, 32, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--white);
        padding: 2rem;
        border-radius: 20px;
        max-width: 900px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px var(--shadow);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .modal-header h2 {
        color: var(--primary);
        font-size: 1.5rem;
        font-weight: 900;
    }

    .modal-close {
        background: var(--bg-light);
        border: 2px solid var(--border);
        padding: 0.5rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s;
        font-weight: 800;
    }

    .modal-close:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .modal-body {
        line-height: 1.7;
    }

    .modal-question {
        background: var(--primary);
        color: white;
        padding: 1.5rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        font-size: 1rem;
        line-height: 1.7;
        font-weight: 600;
    }

    .modal-answer {
        background: var(--bg-light);
        padding: 1.5rem;
        border-radius: 16px;
        font-size: 0.95rem;
        line-height: 1.8;
        color: var(--text-gray);
    }

    .modal-answer a {
        color: var(--primary);
        text-decoration: none;
        word-break: break-all;
        font-weight: 700;
    }

    .modal-answer a:hover {
        text-decoration: underline;
    }

    .message-sources {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
    }

    .source-header {
        font-size: 0.9rem;
        color: var(--text-gray);
        margin-bottom: 0.8rem;
        font-weight: 800;
    }

    .source-item {
        background: var(--white);
        padding: 1rem 1.2rem;
        margin: 0.6rem 0;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
        font-size: 0.85rem;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .source-title {
        font-weight: 800;
        color: var(--text-dark);
        margin-bottom: 0.3rem;
    }

    .source-meta {
        color: var(--text-gray);
        font-size: 0.8rem;
        font-weight: 600;
    }

    .source-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.8rem;
        margin-left: 0.5rem;
        font-weight: 700;
    }

    .source-link:hover {
        text-decoration: underline;
    }

    /* New Project Modal */
    .modal-form {
        padding: 1rem 0;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 800;
    }

    .form-group input {
        width: 100%;
        padding: 0.8rem;
        background: var(--bg-light);
        border: 2px solid var(--border);
        border-radius: 10px;
        color: var(--text-dark);
        font-size: 1rem;
        outline: none;
        transition: all 0.3s;
        font-weight: 600;
    }

    .form-group input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .btn-submit {
        width: 100%;
        padding: 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1rem;
    }

    .btn-submit:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
    }

    /* Scrollbar */
    .project-list::-webkit-scrollbar,
    .chat-list::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
        width: 8px;
    }

    .project-list::-webkit-scrollbar-track,
    .chat-list::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
        background: var(--bg-light);
    }

    .project-list::-webkit-scrollbar-thumb,
    .chat-list::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
    }

    .project-list::-webkit-scrollbar-thumb:hover,
    .chat-list::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
{% include 'chatbot/header.html' with header_title="ğŸ“ í”„ë¡œì íŠ¸ ê´€ë¦¬" header_subtitle="ëŒ€í™”ë¥¼ í”„ë¡œì íŠ¸ë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”" %}

<!-- Main Container -->
<div class="container">
    <!-- Project Sidebar -->
    <div class="project-sidebar">
        <div class="project-header">
            <h3>ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡</h3>
            <button class="btn-new-project" onclick="showNewProjectModal()">
                â• ìƒˆ í”„ë¡œì íŠ¸
            </button>
        </div>
        <div class="project-list" id="project-list">
            <!-- ì „ì²´ ëŒ€í™” í•­ëª© -->
            <div class="project-item all-chats-item active" onclick="selectAllChats()">
                <span class="project-item-name">ğŸ“œ ì „ì²´ ëŒ€í™”</span>
                <span class="project-item-count" id="all-count">0</span>
            </div>
            <!-- í”„ë¡œì íŠ¸ í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
        </div>
    </div>

    <!-- Main Area -->
    <div class="main-area">
        <div class="main-header">
            <h2 id="main-title">ì „ì²´ ëŒ€í™”</h2>
            <p id="main-subtitle">ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input
                    type="text"
                    class="search-input"
                    id="chat-search"
                    placeholder="ëŒ€í™” ë‚´ìš©ì„ ê²€ìƒ‰í•˜ì„¸ìš”..."
                    oninput="filterChats()"
                />
            </div>
        </div>

        <div class="chat-list" id="chat-list">
            <div class="empty-state">
                <h3>ğŸ’¬ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì±—ë´‡ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </div>
</div>

<!-- Chat Detail Modal -->
<div class="modal" id="chat-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ’¬ ëŒ€í™” ë‚´ìš©</h2>
            <button class="modal-close" onclick="closeChatModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="modal-question" id="modal-question"></div>
            <div class="modal-answer" id="modal-answer"></div>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal" id="new-project-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“ ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</h2>
            <button class="modal-close" onclick="closeNewProjectModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form class="modal-form" onsubmit="createProject(event)">
                <div class="form-group">
                    <label for="project-name">í”„ë¡œì íŠ¸ ì´ë¦„</label>
                    <input
                        type="text"
                        id="project-name"
                        placeholder="ì˜ˆ: Transformer ë…¼ë¬¸ ì—°êµ¬"
                        required
                    />
                </div>
                <button type="submit" class="btn-submit">ë§Œë“¤ê¸°</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    let currentProjectId = null;
    let currentChats = [];

    // Django contextì—ì„œ ë°ì´í„° ë¡œë“œ
    const allProjects = {{ projects_json|safe }};
    const allChats = {{ chats_json|safe }};

    console.log('[DEBUG] allChats loaded:', allChats);
    console.log('[DEBUG] allChats length:', allChats ? allChats.length : 'undefined');

    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);

        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        console.log('[DEBUG] DOMContentLoaded - updating count');

        // ì „ì²´ ëŒ€í™” ê°œìˆ˜ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        const countElement = document.getElementById('all-count');
        const count = allChats ? allChats.length : 0;
        console.log('[DEBUG] Count element:', countElement);
        console.log('[DEBUG] Count value:', count);

        if (countElement) {
            countElement.textContent = count;
        }

        // TODO: í”„ë¡œì íŠ¸ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ í™œì„±í™”
        // loadProjects();

        // ì „ì²´ ëŒ€í™” ë¡œë“œ
        loadAllChats();
    });

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
    function loadProjects() {
        const projectList = document.getElementById('project-list');

        // ì „ì²´ ëŒ€í™” í•­ëª© ìœ ì§€ (ì´ë¯¸ HTMLì— ìˆìŒ)
        const allChatsItem = projectList.querySelector('.all-chats-item');

        // í”„ë¡œì íŠ¸ í•­ëª© ì¶”ê°€
        allProjects.forEach(project => {
            // í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ëŒ€í™” ê°œìˆ˜ ê³„ì‚°
            const chatCount = allChats.filter(chat => chat.project_id === project.uid).length;

            const projectItem = document.createElement('div');
            projectItem.className = 'project-item';
            projectItem.setAttribute('data-project-id', project.uid);
            projectItem.innerHTML = `
                <span class="project-item-name">ğŸ“ ${project.folder_name}</span>
                <span class="project-item-count">${chatCount}</span>
            `;
            projectItem.onclick = () => selectProject(project.uid, project.folder_name);
            projectList.appendChild(projectItem);
        });
    }

    // ì „ì²´ ëŒ€í™” ì„ íƒ
    function selectAllChats() {
        currentProjectId = null;

        // í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.project-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector('.all-chats-item').classList.add('active');

        // í—¤ë” ì—…ë°ì´íŠ¸
        document.getElementById('main-title').textContent = 'ì „ì²´ ëŒ€í™”';
        document.getElementById('main-subtitle').textContent = 'ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';

        loadAllChats();
    }

    // í”„ë¡œì íŠ¸ ì„ íƒ
    async function selectProject(projectId, projectName) {
        currentProjectId = projectId;

        // í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.project-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-project-id="${projectId}"]`).classList.add('active');

        // í—¤ë” ì—…ë°ì´íŠ¸
        document.getElementById('main-title').textContent = projectName;
        document.getElementById('main-subtitle').textContent = `${projectName} í”„ë¡œì íŠ¸ì˜ ëŒ€í™” ë‚´ìš©`;

        await loadProjectChats(projectId);
    }

    // ì „ì²´ ëŒ€í™” ë¡œë“œ
    function loadAllChats() {
        console.log('[DEBUG] loadAllChats called');
        console.log('[DEBUG] allChats in loadAllChats:', allChats);
        console.log('[DEBUG] allChats.length in loadAllChats:', allChats ? allChats.length : 'undefined');

        currentChats = allChats;
        renderChatList(allChats);

        // ì „ì²´ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const countElement = document.getElementById('all-count');
        const count = allChats ? allChats.length : 0;
        console.log('[DEBUG] Setting all-count to:', count);

        if (countElement) {
            countElement.textContent = count;
        } else {
            console.error('[ERROR] all-count element not found');
        }

        // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
        document.getElementById('chat-search').value = '';
    }

    // TODO: í”„ë¡œì íŠ¸ë³„ ëŒ€í™” ë¡œë“œ (í–¥í›„ êµ¬í˜„)
    function loadProjectChats(projectId) {
        // í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ëŒ€í™”ë§Œ í•„í„°ë§
        const projectChats = allChats.filter(chat => chat.project_id === projectId);
        currentChats = projectChats;
        renderChatList(projectChats);

        // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
        document.getElementById('chat-search').value = '';
    }

    // ëŒ€í™” ê²€ìƒ‰ í•„í„°ë§
    function filterChats() {
        const searchTerm = document.getElementById('chat-search').value.toLowerCase().trim();

        if (!searchTerm) {
            // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëŒ€í™” í‘œì‹œ
            renderChatList(currentChats);
            return;
        }

        // ê²€ìƒ‰ì–´ê°€ ì§ˆë¬¸ ë˜ëŠ” ë‹µë³€ì— í¬í•¨ëœ ëŒ€í™”ë§Œ í•„í„°ë§
        const filteredChats = currentChats.filter(chat => {
            const questionMatch = chat.question.toLowerCase().includes(searchTerm);
            const answerMatch = chat.answer.toLowerCase().includes(searchTerm);
            return questionMatch || answerMatch;
        });

        renderChatList(filteredChats);

        // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
        if (filteredChats.length === 0) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>"${searchTerm}"ì— ëŒ€í•œ ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    }

    // ëŒ€í™” ëª©ë¡ ë Œë”ë§
    function renderChatList(chats) {
        const chatList = document.getElementById('chat-list');

        if (!chats || chats.length === 0) {
            showEmptyState();
            return;
        }

        chatList.innerHTML = chats.map(chat => {
            const searchBadgeText = {
                'internal': 'ğŸ“š ë‚´ë¶€ ê²€ìƒ‰',
                'hybrid': 'ğŸ” í•˜ì´ë¸Œë¦¬ë“œ',
                'vector': 'ğŸ¯ ë²¡í„° ê²€ìƒ‰',
                'cluster': 'ğŸ” í´ëŸ¬ìŠ¤í„°',
                'web': 'ğŸŒ ì›¹ ê²€ìƒ‰',
                'rejected': 'âŒ ê´€ë ¨ ì—†ìŒ'
            }[chat.search_type] || chat.search_type;

            const sourceCount = chat.sources ? chat.sources.length : 0;

            return `
                <div class="chat-card" onclick='showChatModal(${JSON.stringify(chat)})'>
                    <div class="chat-card-header">
                        <div class="chat-card-question">${chat.question}</div>
                        <div class="chat-card-time">${new Date(chat.created_at).toLocaleString('ko-KR')}</div>
                    </div>
                    <div class="chat-card-answer">${chat.answer}</div>
                    <div class="chat-card-footer">
                        <span class="search-badge ${chat.search_type}">${searchBadgeText}</span>
                        <span class="source-count">ğŸ“š ${sourceCount}ê°œ ì¶œì²˜</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState() {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = `
            <div class="empty-state">
                <h3>ğŸ’¬ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì±—ë´‡ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            </div>
        `;
    }

    // ëŒ€í™” ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
    function showChatModal(chat) {
        document.getElementById('modal-question').textContent = chat.question;

        // ë‹µë³€ í¬ë§·íŒ…
        const formattedAnswer = formatAnswerText(linkifyText(chat.answer));

        // ê²€ìƒ‰ íƒ€ì… ë°°ì§€
        let searchBadgeHtml = '';
        if (chat.search_type) {
            const badgeText = {
                'internal': 'ğŸ“š ë‚´ë¶€ ê²€ìƒ‰',
                'hybrid': 'ğŸ” í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰',
                'vector': 'ğŸ¯ ë²¡í„° ê²€ìƒ‰',
                'cluster': 'ğŸ” í´ëŸ¬ìŠ¤í„° ê²€ìƒ‰',
                'web': 'ğŸŒ ì›¹ ê²€ìƒ‰',
                'rejected': 'âŒ ê´€ë ¨ ì—†ìŒ'
            }[chat.search_type] || chat.search_type;

            searchBadgeHtml = `<div class="search-badge ${chat.search_type}">${badgeText}</div>`;
        }

        // ì¶œì²˜ ì •ë³´
        let sourcesHtml = '';
        if (chat.search_type !== 'rejected' && chat.sources && chat.sources.length > 0) {
            const sourceItems = chat.sources.map((src) => {
                if (src.type === 'web') {
                    const displayTitle = src.title && src.title !== 'Web Search Result'
                        ? src.title
                        : 'ì›¹ ê²€ìƒ‰ ê²°ê³¼';

                    return `
                        <div class="source-item">
                            <div class="source-title">ğŸŒ ${displayTitle}</div>
                            <div class="source-meta">
                                <a href="${src.url}" target="_blank" class="source-link">ë§í¬ ë³´ê¸° â†’</a>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="source-item">
                            <div class="source-title">ğŸ“„ ${src.title}</div>
                            <div class="source-meta">
                                ${src.authors ? src.authors.join(', ') : ''} ${src.year ? 'Â· ' + src.year : ''}<br>
                                ${src.huggingface_url ? `<a href="${src.huggingface_url}" target="_blank" class="source-link">HuggingFace â†’</a>` : ''}
                                ${src.github_url ? `<a href="${src.github_url}" target="_blank" class="source-link">GitHub â†’</a>` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');

            sourcesHtml = `
                <div class="message-sources">
                    <div class="source-header">ğŸ“š ì°¸ì¡° ìë£Œ (${chat.sources.length}ê°œ)</div>
                    ${sourceItems}
                </div>
            `;
        }

        document.getElementById('modal-answer').innerHTML = searchBadgeHtml + formattedAnswer + sourcesHtml;
        document.getElementById('chat-modal').classList.add('active');
    }

    // ëŒ€í™” ëª¨ë‹¬ ë‹«ê¸°
    function closeChatModal() {
        document.getElementById('chat-modal').classList.remove('active');
    }

    // ìƒˆ í”„ë¡œì íŠ¸ ëª¨ë‹¬ í‘œì‹œ
    function showNewProjectModal() {
        document.getElementById('new-project-modal').classList.add('active');
    }

    // ìƒˆ í”„ë¡œì íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeNewProjectModal() {
        document.getElementById('new-project-modal').classList.remove('active');
        document.getElementById('project-name').value = '';
    }

    // TODO: í”„ë¡œì íŠ¸ ìƒì„± (í–¥í›„ êµ¬í˜„)
    async function createProject(event) {
        event.preventDefault();

        const projectName = document.getElementById('project-name').value.trim();
        if (!projectName) return;

        try {
            const response = await fetch('{% url "chatbot:create_project" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ folder_name: projectName })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨');
            }

            const data = await response.json();

            if (data.success) {
                // ìƒˆ í”„ë¡œì íŠ¸ë¥¼ allProjectsì— ì¶”ê°€
                allProjects.push(data.project);

                closeNewProjectModal();

                // í”„ë¡œì íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                // TODO: ì „ì²´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  ë™ì ìœ¼ë¡œ ì¶”ê°€
                alert('í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            }

        } catch (error) {
            console.error('[ERROR] í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
            alert(error.message || 'í”„ë¡œì íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // URLì„ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë³€í™˜
    function linkifyText(text) {
        const urlPattern = /(https?:\/\/[^\s]+)/g;

        return text.replace(urlPattern, function(url) {
            let cleanUrl = url;
            const punctuation = /[.,;!?)]$/;
            let suffix = '';

            if (punctuation.test(url)) {
                cleanUrl = url.slice(0, -1);
                suffix = url.slice(-1);
            }

            return `<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>${suffix}`;
        });
    }

    // ë‹µë³€ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
    function formatAnswerText(text) {
        let formatted = text.replace(/\n/g, '<br>');
        formatted = formatted.replace(/^(\d+\).*?)$/gm, '<div style="margin: 0.3rem 0;">$1</div>');
        formatted = formatted.replace(/^[-*â€¢]\s(.+)$/gm, '<div style="margin: 0.3rem 0; padding-left: 1rem;">â€¢ $1</div>');

        return formatted;
    }

    // í…Œë§ˆ í† ê¸€
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);

        const themeBtn = document.querySelector('.theme-toggle');
        if (themeBtn) {
            themeBtn.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        localStorage.setItem('theme', newTheme);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('chat-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeChatModal();
        }
    });

    document.getElementById('new-project-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeNewProjectModal();
        }
    });
</script>
{% endblock %}
