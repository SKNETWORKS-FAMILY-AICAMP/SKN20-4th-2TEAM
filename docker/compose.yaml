services:
  # Django 웹 애플리케이션 서비스
  backend:
    image: grustar02/django-app
    platform: linux/amd64
    ports:
      - "80:80"
    volumes:
      # SQLite DB 파일을 호스트에 마운트하여 데이터 유지
      - ../data/db.sqlite3:/app/backend/db.sqlite3
    # RAG API 서비스가 실행된 후에 backend 서비스를 시작합니다.
    depends_on:
      rag_api:
        condition: service_healthy
    # Django 앱이 RAG API를 호출할 주소를 환경 변수로 전달합니다.
    environment:
      - RAG_API_URL=http://rag_api:8001
    # 컨테이너 재시작 정책
    restart: unless-stopped

  # FastAPI RAG API 서비스
  rag_api:
    image: grustar02/rag-api
    platform: linux/amd64
    ports:
      - "8001:8001"
    volumes:
      # Vector DB 데이터 유지
      - ../data/vector_db:/app/data/vector_db
      # HuggingFace 모델 캐시 유지 (Cross-encoder 등)
      - ../data/huggingface_cache:/root/.cache/huggingface
    # .env 파일로부터 환경 변수를 읽어옵니다.
    env_file:
      - ../.env
    # 컨테이너 재시작 정책
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/api/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s